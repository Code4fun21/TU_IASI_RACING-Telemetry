import axios from 'axios';
import type { Session, Driver, Track, Monopost } from '@telemetry/shared';

const API_URL = (import.meta as any).env.VITE_API_URL;

export const api = {
  // --- 1. UPLOAD FILE ---
  // We send the raw file to the worker, which streams it to R2
  uploadFile: async (file: File) => {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await axios.post<{ fileName: string }>(
      `${API_URL}/upload`, 
      formData,
      { headers: { 'Content-Type': 'multipart/form-data' } }
    );
    return response.data.fileName; // Returns the unique filename generated by backend
  },

  // --- 2. SAVE METADATA ---
  saveSession: async (sessionData: Session) => {
    const response = await axios.post<{ success: boolean; id: number }>(
      `${API_URL}/sessions`, 
      sessionData
    );
    return response.data;
  },

  // --- 3. GET SESSIONS ---
  getSessions: async () => {
    const response = await axios.get<Session[]>(`${API_URL}/sessions`);
    return response.data;
  },

  // --- 4. DOWNLOAD FILE ---
  downloadFile: async (fileName: string) => {
    const response = await axios.get(`${API_URL}/download/${fileName}`, {
      responseType: 'blob', // Important: tells axios to handle binary data
    });
    return response.data; // Returns a Blob (file-like object)
  }
};